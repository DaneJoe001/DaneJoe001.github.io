# ProjectMultimedia - Qt6 + FFmpeg + SDL2 å¤šåª’ä½“æ’­æ”¾å™¨
 
 > åŸºäº Qt6 + FFmpeg + SDL2 çš„æœ¬åœ°åª’ä½“æ’­æ”¾å™¨ç»ƒæ‰‹é¡¹ç›®ï¼ˆè§†é¢‘æ¸²æŸ“ + éŸ³é¢‘æ’­æ”¾ + A/V åŒæ­¥ä¸èƒŒå‹ï¼‰
 
 ![](/markdown/assets/projects/project_multimedia/default_open.png)
 
 ## é¡¹ç›®æ¦‚è¿°
 
 `ProjectMultimedia` æ˜¯ä¸€ä¸ªæœ¬åœ°å¤šåª’ä½“æ’­æ”¾å™¨é¡¹ç›®ï¼Œå½“å‰æ”¯æŒ GUI æ‰“å¼€æœ¬åœ°åª’ä½“æ–‡ä»¶å¹¶æ’­æ”¾ï¼ˆè§†é¢‘æ¸²æŸ“ + éŸ³é¢‘æ’­æ”¾ï¼‰ã€‚
 
 æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®é‡Œçš„é‡ç‚¹ä¸æ˜¯â€œèƒ½æ’­â€ï¼Œè€Œæ˜¯å›´ç»•å·¥ç¨‹åŒ–ä¸è¿è¡Œæ—¶é—®é¢˜åšé’ˆå¯¹æ€§çš„å®è·µï¼š
 
 - **A/V åŒæ­¥**ï¼šç»´æŠ¤ audio clockï¼ˆå¾®ç§’ï¼‰ä½œä¸ºè§†é¢‘è°ƒåº¦åŸºå‡†
 - **èƒŒå‹ï¼ˆBackpressureï¼‰**ï¼šé€šè¿‡é˜Ÿåˆ—æ°´ä½æ§åˆ¶è§£ç æš‚åœ/æ¢å¤ï¼Œé¿å…å†…å­˜ä¸å»¶è¿Ÿå¤±æ§
 - **å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰**ï¼šå‘¨æœŸæ€§è¾“å‡º `METRIC` æ—¥å¿—è¾…åŠ©å®šä½å¸§ç‡ã€ä¸¢å¸§ã€é˜Ÿåˆ—é•¿åº¦ä¸åŒæ­¥è¯¯å·®
 
 ![](/markdown/assets/projects/project_multimedia/open_file_dialog.png)
 
 ## GitHub é“¾æ¥
 
 ğŸ”— **ä»“åº“åœ°å€**: https://github.com/DaneJoe001/ProjectMultimediaPlayer

## æŠ€æœ¯æ ˆï¼ˆä»¥æºç ä¸ºå‡†ï¼‰

- **C++20 / CMake Presets**
- **Qt6**ï¼ˆWidgetsï¼‰
- **SDL2**ï¼ˆè§†é¢‘æ¸²æŸ“ + éŸ³é¢‘ callbackï¼‰
- **FFmpeg**ï¼ˆè§£å°è£…/è§£ç  + swresampleï¼‰

## æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®é‡Œåšäº†ä»€ä¹ˆï¼ˆèƒ½åŠ›ç‚¹ï¼‰

- **å¤šåª’ä½“æ’­æ”¾é“¾è·¯çš„å®Œæ•´é—­ç¯**ï¼šä»æ–‡ä»¶é€‰æ‹©ã€è§£å°è£…ã€è§£ç ã€ç¼“å­˜ã€æ¸²æŸ“/éŸ³é¢‘è¾“å‡ºåˆ°é€€å‡ºæ¸…ç†ã€‚
 - **A/V åŒæ­¥ä¸è°ƒåº¦**ï¼šä»¥éŸ³é¢‘æ—¶é’Ÿä½œä¸º master clockï¼Œå¯¹è§†é¢‘è¿›è¡Œâ€œç­‰å¾…/ä¸¢å¸§â€é˜ˆå€¼æ§åˆ¶ã€‚
 - **èƒŒå‹ï¼ˆBackpressureï¼‰**ï¼šé€šè¿‡é˜Ÿåˆ—æ°´ä½æ§åˆ¶æš‚åœ/æ¢å¤è§£ç ï¼Œé¿å…å†…å­˜ä¸å»¶è¿Ÿå¤±æ§ã€‚
 - **å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰**ï¼šå‘¨æœŸæ€§è¾“å‡ºæŒ‡æ ‡ï¼ˆfps/drop/é˜Ÿåˆ—é•¿åº¦/åŒæ­¥è¯¯å·®ï¼‰ï¼Œæ–¹ä¾¿å®šä½å¡é¡¿ä¸ä¸åŒæ­¥ã€‚
 - **èµ„æºç”Ÿå‘½å‘¨æœŸæ²»ç†ï¼ˆRAIIï¼‰ä¸é€€å‡ºç¨³å®šæ€§**ï¼šSDL èµ„æºæ™ºèƒ½æŒ‡é’ˆå°è£… + è·¨çº¿ç¨‹ stop ä¿æŠ¤ï¼Œé™ä½å´©æºƒä¸æ³„æ¼æ¦‚ç‡ã€‚
 
 ![](/markdown/assets/projects/project_multimedia/playing.gif)
 
 ## æ’­æ”¾é“¾è·¯ä¸çº¿ç¨‹æ¨¡å‹ï¼ˆä»ä»£ç è§†è§’ï¼‰
 
 ç»“åˆé¡¹ç›® README ä¸æºç ç›®å½•ï¼Œæˆ‘æŠŠèŒè´£æ‹†æˆ 4 æ¡ä¸»çº¿ï¼š
 
```
UI(QMainWindow)
  -> Decode Service (è§£å°è£…/è§£ç )
  -> Controller (å¸§é˜Ÿåˆ—ç¼“å­˜ + å®šæ—¶å™¨è°ƒåº¦)
  -> Renderer / Audio (SDL video + SDL audio callback)
```

æˆ‘ä¸ä»…è·‘é€šäº†æ’­æ”¾é“¾è·¯ï¼Œè¿˜å›´ç»•è¿è¡Œæ—¶é—®é¢˜ï¼ˆåŒæ­¥ã€èƒŒå‹ã€é€€å‡ºè·¯å¾„ï¼‰è¡¥é½äº†å¯è§‚æµ‹ä¸å¯è°ƒå‚çš„å·¥ç¨‹åŒ–æ²»ç†èƒ½åŠ›ã€‚

## é¡¹ç›®ç»“æ„ï¼ˆæŒ‰èŒè´£ï¼‰

ï¼ˆèŠ‚é€‰è‡ªé¡¹ç›® `README.md` çš„èŒè´£æ‹†åˆ†ï¼‰

- `source/main/widget_main.cpp`ï¼šQt GUI å…¥å£
- `source/service/media_decode_service.cpp`ï¼šè§£ç æœåŠ¡ä¸çº¿ç¨‹ç®¡ç†
- `source/controller/media_controller.cpp`ï¼šå¸§é˜Ÿåˆ—ç¼“å­˜ + å®šæ—¶å™¨è°ƒåº¦ï¼ˆA/V åŒæ­¥ï¼‰
- `source/audio/sdl_audio_renderer.cpp`ï¼šSDL audio callback + PCM é˜Ÿåˆ—
- `source/renderer/sdl_frame_renderer.cpp`ï¼šSDL texture/renderer/window ç®¡ç†ä¸ç»˜åˆ¶
- `source/view/main_window.cpp`ã€`source/view/sdl_frame_widget.cpp`ï¼šQt ä¸»çª—å£ä¸ SDL æ¸²æŸ“æ‰¿è½½æ§ä»¶

## å…³é”®å®ç° 1ï¼šè°ƒåº¦æ§åˆ¶å™¨ï¼ˆç¼“å­˜ + æŒ‡æ ‡ï¼‰

æ§åˆ¶å™¨ç»´æŠ¤éŸ³è§†é¢‘ç¼“å†²ï¼Œå¹¶è®°å½•å…³é”®æŒ‡æ ‡ï¼ˆèŠ‚é€‰è‡ª `include/controller/media_controller.hpp`ï¼‰ï¼š

```cpp
class MediaController : public QObject
{
public:
    Q_OBJECT

    MediaController(std::shared_ptr<TimeService> time_service, QObject* parent = nullptr);
    ~MediaController() override;

    void init();
    void stop_audio();
    void stop_video();

signals:
    void renderer_video_frame(SessionFrame frame);
    void renderer_audio_frame(SessionFrame frame);
    void paused_decode(bool is_paused);

private:
    QQueue<SessionFrame> m_video_frames;
    QQueue<SessionFrame> m_audio_frames;

    std::optional<int64_t> m_audio_pts_base_us;

    std::atomic<int64_t> m_metrics_video_rendered = 0;
    std::atomic<int64_t> m_metrics_video_dropped = 0;
    std::atomic<int64_t> m_metrics_diff_max_abs_us = 0;
};
```

è¿™éƒ¨åˆ†å¯¹åº”äº†æˆ‘åœ¨ README é‡Œå¼ºè°ƒçš„ä¸¤æ¡æ ¸å¿ƒç›®æ ‡ï¼š

- ä»¥éŸ³é¢‘ä¸ºåŸºå‡†åšç®€å•åŒæ­¥ï¼ˆaudio clockï¼‰ã€‚
- é€šè¿‡æŒ‡æ ‡å¯è§†åŒ–åŒæ­¥è¯¯å·®ä¸é˜Ÿåˆ—çŠ¶æ€ï¼Œæ–¹ä¾¿è¿­ä»£ã€‚

### çœŸå®å®ç°ï¼šæŒ‡æ ‡æ—¥å¿—ï¼ˆMETRICï¼‰

æ§åˆ¶å™¨åˆå§‹åŒ–æ—¶ä¼šæ³¨å†Œä¸€ä¸ª 1s å‘¨æœŸä»»åŠ¡ï¼Œè¾“å‡º fps/drop/é˜Ÿåˆ—é•¿åº¦/åŒæ­¥è¯¯å·®ï¼ˆèŠ‚é€‰è‡ª `source/controller/media_controller.cpp`ï¼‰ï¼š

```cpp
m_metrics_task_id = DaneJoe::TimerManager::get_instance().add_periodic_task(
    1s,
    [this]()
    {
        int64_t rendered = m_metrics_video_rendered.exchange(0);
        int64_t dropped = m_metrics_video_dropped.exchange(0);
        int64_t diff_sum_us = m_metrics_diff_sum_us.exchange(0);
        int64_t diff_count = m_metrics_diff_count.exchange(0);
        int64_t diff_max_abs_us = m_metrics_diff_max_abs_us.exchange(0);
        int64_t vq_len = m_metrics_video_queue_size.load();
        int64_t aq_len = m_metrics_audio_queue_size.load();

        double avg_ms = 0.0;
        if (diff_count > 0)
        {
            avg_ms = static_cast<double>(diff_sum_us) / static_cast<double>(diff_count) / 1000.0;
        }
        double max_ms = static_cast<double>(diff_max_abs_us) / 1000.0;

        DANEJOE_LOG_INFO(
            "default",
            "METRIC",
            "fps={} drop={} vq={} aq={} av_diff_avg={:.2f}ms av_diff_max={:.2f}ms",
            rendered,
            dropped,
            vq_len,
            aq_len,
            avg_ms,
            max_ms);
    },
    -1);
```

è¿™æ®µè®¾è®¡é‡Œæˆ‘ä¸»è¦å¼ºè°ƒä¸¤ç‚¹â€œå·¥ç¨‹åŒ–æ€ç»´â€ï¼š

- **å¯é‡åŒ–**ï¼šæŠŠâ€œæ„Ÿè§‰å¡é¡¿/ä¸åŒæ­¥â€å˜æˆå¯åº¦é‡çš„æŒ‡æ ‡ã€‚
- **å¯å®šä½**ï¼šé€šè¿‡ `vq/aq` è¯†åˆ«æ˜¯è§£ç è·Ÿä¸ä¸Šè¿˜æ˜¯æ¸²æŸ“/è¾“å‡ºè·Ÿä¸ä¸Šï¼›é€šè¿‡ `av_diff` åˆ¤æ–­åŒæ­¥ç­–ç•¥æ˜¯å¦è¿‡æ¿€ã€‚

### çœŸå®å®ç°ï¼šèƒŒå‹æ°´ä½ï¼ˆHigh/Low Watermarkï¼‰

è§†é¢‘å¸§é˜Ÿåˆ—è¾¾åˆ°é«˜æ°´ä½æ—¶æš‚åœè§£ç ï¼Œé™åˆ°ä½æ°´ä½æ—¶æ¢å¤ï¼ˆåŒæ ·æ¥è‡ª `media_controller.cpp`ï¼‰ï¼š

```cpp
void MediaController::on_video_frame_ready(SessionFrame frame)
{
    m_video_frames.enqueue(frame);
    if (m_video_frames.size() >= 64)
    {
        emit paused_decode(true);
    }
}

void MediaController::on_video_frame_timer_tick()
{
    // ...
    emit renderer_video_frame(m_video_frames.dequeue());
    if (m_video_frames.size() < 32)
    {
        emit paused_decode(false);
    }
}
```

æˆ‘éœ€è¦èƒŒå‹æ¥è§£å†³ä¸¤ä¸ªæ’­æ”¾ä¾§å¸¸è§é—®é¢˜ï¼š

- é¿å…ç¼“å­˜æ— é™å¢é•¿å¯¼è‡´å†…å­˜ä¸Šæ¶¨ã€‚
- é™ä½â€œç¼“å­˜è¶Šæ¥è¶Šå¤§å¯¼è‡´å»¶è¿Ÿè¶Šæ¥è¶Šå¤§â€çš„ä½“éªŒé—®é¢˜ã€‚

## å…³é”®å®ç° 2ï¼šSDL æ¸²æŸ“å™¨ï¼ˆRAII + çº¹ç†æ›´æ–°ï¼‰

æ¸²æŸ“ä¾§å°è£…äº† SDL èµ„æºçš„æ™ºèƒ½æŒ‡é’ˆï¼ˆèŠ‚é€‰è‡ª `include/renderer/sdl_frame_renderer.hpp`ï¼‰ï¼š

```cpp
struct SDL_window_deleter
{
    void operator()(SDL_Window* window)const;
};

struct SDL_renderer_deleter
{
    void operator()(SDL_Renderer* renderer)const;
};

struct SDL_texture_deleter
{
    void operator()(SDL_Texture* texture)const;
};

using SDL_window_ptr = std::unique_ptr<SDL_Window, SDL_window_deleter>;
using SDL_renderer_ptr = std::unique_ptr<SDL_Renderer, SDL_renderer_deleter>;
using SDL_texture_ptr = std::unique_ptr<SDL_Texture, SDL_texture_deleter>;

class SDLFrameRenderer : public IFrameRenderer
{
public:
    bool init() override;
    bool draw(AVFramePtr frame)override;

private:
    SDL_window_ptr m_window = nullptr;
    SDL_renderer_ptr m_renderer = nullptr;
    SDL_texture_ptr m_texture = nullptr;
};
```

åœ¨å¤šåª’ä½“é¡¹ç›®é‡Œï¼Œèµ„æºç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹é€€å‡ºè·¯å¾„å¾€å¾€æ˜¯ bug çš„ä¸»è¦æ¥æºä¹‹ä¸€ï¼Œæˆ‘åœ¨è¿™é‡Œé€šè¿‡ RAII è®©æ¸…ç†è¡Œä¸ºæ›´ç¨³å®šã€‚

## A/V åŒæ­¥ç­–ç•¥ï¼ˆåŸºäºçœŸå®ä»£ç çš„å–èˆè¯´æ˜ï¼‰

æ’­æ”¾å™¨çš„åŒæ­¥æœ¬è´¨æ˜¯ï¼š**è®©è§†é¢‘çš„å±•ç¤ºæ—¶é—´è·ŸéšéŸ³é¢‘æ’­æ”¾è¿›åº¦**ã€‚åœ¨ `MediaController::on_video_frame_timer_tick()` ä¸­ï¼Œæˆ‘é‡‡ç”¨äº†é˜ˆå€¼ç­–ç•¥ï¼š

- ç”¨ `m_audio_pts_base_us` åšé¦–å¸§ PTS åŸºå‡†å¯¹é½ï¼Œé¿å…â€œéŸ³è§†é¢‘é¦–å¸§åŸºå‡†ä¸ä¸€è‡´â€å¯¼è‡´å›ºå®šåç§»ã€‚
- å¼•å…¥ `AUDIO_OUTPUT_LATENCY_US`ï¼ˆè®¾å¤‡è¾“å‡ºå»¶è¿Ÿï¼‰ä¸ `VIDEO_LEAD_US`ï¼ˆè§†é¢‘æå‰é‡ï¼‰åšç»éªŒè¡¥å¿ã€‚
- å½“è§†é¢‘æ˜æ˜¾â€œè¶…å‰â€æ—¶ç­‰å¾…ï¼›å½“è§†é¢‘æ˜æ˜¾â€œè½åâ€æ—¶ä¸¢å¸§è¿½èµ¶ã€‚

æˆ‘é€‰æ‹©è¿™ç§ç­–ç•¥ä¸»è¦æ˜¯å› ä¸ºï¼š

- å®ç°æˆæœ¬ä½ã€å¯æ§ã€ä¾¿äºè°ƒå‚ã€‚
- å¯¹å¸¸è§åª’ä½“è¶³å¤Ÿç¨³å®šï¼Œé€‚åˆç»ƒæ‰‹é¡¹ç›®åšæˆå¯æ¼”ç¤ºé—­ç¯ã€‚

## ç»“æ„å¯¼èˆªï¼ˆå…³æ³¨ç‚¹ç´¢å¼•ï¼‰

- **å¤šåª’ä½“é“¾è·¯**ï¼šè§£ç /æ¸²æŸ“/éŸ³é¢‘ callback çš„é“¾è·¯ï¼Œä»¥åŠåŒæ­¥ç­–ç•¥çš„è½åœ°æ–¹å¼ã€‚
- **å·¥ç¨‹åŒ–ä¸ç¨³å®šæ€§**ï¼šèƒŒå‹æ°´ä½ã€æŒ‡æ ‡ä½“ç³»ï¼ˆMETRICï¼‰ã€SDL èµ„æº RAII ä¸é€€å‡ºè·¯å¾„å¤„ç†ã€‚

## æ„å»ºä¸è¿è¡Œï¼ˆWindows / MSVCï¼‰

é¡¹ç›®ä½¿ç”¨ CMake Presetsï¼ˆç¤ºä¾‹è§ READMEï¼‰ï¼š

```powershell
cmake --preset win-msvc-debug
cmake --build --preset win-msvc-debug
```

## ç›¸å…³èµ„æº

- ğŸ“Œ **README**: https://github.com/DaneJoe001/ProjectMultimediaPlayer
- ğŸ“Œ **MediaControllerï¼ˆä»“åº“å†…æœç´¢ï¼‰**: https://github.com/DaneJoe001/ProjectMultimediaPlayer/search?q=media_controller.hpp
- ğŸ“Œ **SDLFrameRendererï¼ˆä»“åº“å†…æœç´¢ï¼‰**: https://github.com/DaneJoe001/ProjectMultimediaPlayer/search?q=sdl_frame_renderer.hpp

---

**æŠ€æœ¯æ ˆæ ‡ç­¾**: `C++20` `Qt6` `FFmpeg` `SDL2` `å¤šåª’ä½“` `A/VåŒæ­¥` `èƒŒå‹` `CMake`
